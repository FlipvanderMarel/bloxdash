<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Blox Dash - Fix & Play</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap');

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #0f172a;
            font-family: 'Outfit', sans-serif;
            touch-action: none;
        }

        #game-container {
            position: relative; width: 100vw; height: 100vh;
            display: flex; justify-content: center; align-items: center;
        }

        canvas { display: block; background: #1e293b; }

        .ui-overlay {
            position: absolute; inset: 0;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; z-index: 100;
            background: rgba(15, 23, 42, 0.95); 
            backdrop-filter: blur(10px);
            text-align: center; padding: 20px;
        }

        .btn {
            background: #10b981;
            padding: 12px 30px; font-size: 1.1rem; font-weight: 900;
            color: white; border-radius: 12px; cursor: pointer;
            border: none; margin: 6px; min-width: 240px;
            text-transform: uppercase;
            transition: transform 0.1s, opacity 0.2s;
        }

        .btn:active { transform: scale(0.95); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .hidden { display: none !important; }

        .hud {
            position: absolute; top: 20px; width: 100%;
            display: flex; justify-content: space-between; padding: 0 30px;
            pointer-events: none; z-index: 50;
        }

        .hud-box {
            background: rgba(0,0,0,0.6); padding: 8px 16px;
            border-radius: 12px; font-weight: 900; color: #fff;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .leaderboard-list {
            width: 100%; max-width: 450px;
            max-height: 400px; overflow-y: auto;
            margin: 20px 0;
        }

        .leaderboard-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 15px; margin-bottom: 5px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px; font-weight: 700;
        }

        .top-3 { border-left: 4px solid #fbbf24; background: rgba(251, 191, 36, 0.1); }
        
        input {
            background: #1e293b; border: 2px solid #334155;
            color: white; padding: 12px; border-radius: 12px;
            width: 100%; max-width: 300px; margin-bottom: 10px;
            text-align: center; font-weight: 700; outline: none;
        }
        input:focus { border-color: #10b981; }

        .mode-tag {
            font-size: 0.75rem; padding: 2px 8px; border-radius: 4px;
            background: rgba(255,255,255,0.1); color: #94a3b8;
            margin-left: 10px; text-transform: lowercase;
        }
    </style>
</head>
<body>

<div id="game-container">
    <div id="hud" class="hud hidden">
        <div class="hud-box">SCORE: <span id="score-val">0</span> <span id="mode-display" class="mode-tag"></span></div>
        <div class="hud-box" style="color: #fbbf24;">üíé <span id="gem-val">0</span></div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <!-- Hoofdmenu -->
    <div id="ui-menu" class="ui-overlay">
        <h1 class="text-6xl font-black mb-8 italic">BLOX DASH</h1>
        <button class="btn" onclick="showLevelSelect()">SPEEL NU</button>
        <button class="btn" style="background: #6366f1" onclick="showLeaderboard()">LEADERBOARD üèÜ</button>
        <button class="btn" style="background: #475569" onclick="toggleShop()">SKIN SHOP</button>
    </div>

    <!-- Niveau Selectie -->
    <div id="ui-levels" class="ui-overlay hidden">
        <h2 class="text-3xl font-black mb-6">KIES MOEILIJKHEID</h2>
        <button class="btn" style="background: #10b981" onclick="startGame('easy')">EASY</button>
        <button class="btn" style="background: #3b82f6" onclick="startGame('medium')">MEDIUM</button>
        <button class="btn" style="background: #f59e0b" onclick="startGame('hard')">HARD</button>
        <button class="btn" style="background: #ef4444" onclick="startGame('hardcore')">HARDCORE</button>
        <button class="btn mt-4" style="background: #475569" onclick="showMenu()">TERUG</button>
    </div>

    <!-- Leaderboard -->
    <div id="ui-leaderboard" class="ui-overlay hidden">
        <h2 class="text-3xl font-black mb-4 text-indigo-400">WERELD TOP 10</h2>
        <div id="leaderboard-content" class="leaderboard-list"></div>
        <button class="btn" onclick="showMenu()">TERUG</button>
    </div>

    <!-- Game Over -->
    <div id="ui-gameover" class="ui-overlay hidden">
        <h2 class="text-5xl font-black text-red-500 mb-2">CRASHED!</h2>
        <p class="text-xl mb-6 font-bold">Score: <span id="final-score">0</span></p>
        
        <div id="save-score-zone" class="w-full flex flex-col items-center">
            <input type="text" id="player-name" placeholder="JE NAAM" maxlength="15">
            <button id="submit-btn" class="btn" style="background: #6366f1" onclick="submitScore()">SCORE OPSLAAN</button>
        </div>

        <div class="mt-4">
            <button class="btn" onclick="retryGame()">OPNIEUW</button>
            <button class="btn" style="background: #475569" onclick="showMenu()">MENU</button>
        </div>
    </div>

    <!-- Skin Shop -->
    <div id="ui-shop" class="ui-overlay hidden">
        <h2 class="text-3xl font-black mb-6">SKIN SHOP</h2>
        <div id="skin-list" class="grid grid-cols-2 gap-4 mb-8"></div>
        <button class="btn" onclick="toggleShop()">TERUG</button>
    </div>
</div>

<script>
    // Firebase configuratie
    const firebaseConfig = JSON.parse(__firebase_config);
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'blox-dash-v2';

    let user = null;
    const initAuth = async () => {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await auth.signInWithCustomToken(__initial_auth_token);
            } else {
                await auth.signInAnonymously();
            }
        } catch (e) {
            console.error("Auth error:", e);
        }
    };
    initAuth();
    auth.onAuthStateChanged(u => user = u);

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    let gameState = 'MENU';
    let score = 0;
    let selectedMode = 'easy';
    let gems = parseInt(localStorage.getItem('blox_gems')) || 0;
    let currentSkinIdx = parseInt(localStorage.getItem('blox_skin')) || 0;
    
    const skins = [
        { name: 'Classic', color: '#10b981' },
        { name: 'Sky', color: '#3b82f6' },
        { name: 'Fire', color: '#ef4444' },
        { name: 'Gold', color: '#fbbf24' },
        { name: 'Purple', color: '#a855f7' },
        { name: 'Ghost', color: '#94a3b8' }
    ];

    const modeSettings = {
        easy: { speed: 7, minInterval: 80, maxInterval: 140, gravity: 0.75, jump: -13 },
        medium: { speed: 10, minInterval: 60, maxInterval: 110, gravity: 0.8, jump: -14 },
        hard: { speed: 13, minInterval: 45, maxInterval: 80, gravity: 0.9, jump: -15 },
        hardcore: { speed: 17, minInterval: 30, maxInterval: 55, gravity: 1.0, jump: -16 }
    };

    let player = { x: 100, y: 0, w: 42, h: 42, vy: 0, rotation: 0, grounded: false };
    let obstacles = [];
    let nextSpawnTime = 0;
    let frame = 0;

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }

    function showMenu() {
        document.querySelectorAll('.ui-overlay').forEach(u => u.classList.add('hidden'));
        document.getElementById('hud').classList.add('hidden');
        document.getElementById('ui-menu').classList.remove('hidden');
        gameState = 'MENU';
    }

    function showLevelSelect() {
        document.querySelectorAll('.ui-overlay').forEach(u => u.classList.add('hidden'));
        document.getElementById('ui-levels').classList.remove('hidden');
    }

    function startGame(mode) {
        selectedMode = mode;
        document.querySelectorAll('.ui-overlay').forEach(u => u.classList.add('hidden'));
        document.getElementById('hud').classList.remove('hidden');
        document.getElementById('save-score-zone').classList.remove('hidden');
        document.getElementById('mode-display').innerText = mode.toUpperCase();
        
        gameState = 'PLAYING';
        score = 0; obstacles = []; frame = 0;
        player.y = canvas.height - 150; 
        player.vy = 0;
        player.rotation = 0;
        
        setNextSpawn();
    }

    function setNextSpawn() {
        const settings = modeSettings[selectedMode];
        const randomExtra = Math.floor(Math.random() * (settings.maxInterval - settings.minInterval));
        nextSpawnTime = frame + settings.minInterval + randomExtra;
    }

    function retryGame() {
        startGame(selectedMode);
    }

    function jump() {
        if (gameState === 'PLAYING' && player.grounded) {
            player.vy = modeSettings[selectedMode].jump;
            player.grounded = false;
        }
    }

    function update() {
        if (gameState !== 'PLAYING') return;

        frame++;
        score++;
        document.getElementById('score-val').innerText = Math.floor(score/10);
        
        const settings = modeSettings[selectedMode];
        player.vy += settings.gravity;
        player.y += player.vy;

        const groundY = canvas.height - 100;
        if (player.y + player.h > groundY) {
            player.y = groundY - player.h;
            player.vy = 0; 
            player.grounded = true; 
            player.rotation = 0;
        } else {
            player.grounded = false;
            player.rotation += 0.15;
        }

        if (frame >= nextSpawnTime) {
            const type = Math.random() > 0.5 ? 'box' : 'spike';
            obstacles.push({ 
                x: canvas.width, 
                y: groundY - 40, 
                w: 40, 
                h: 40, 
                type: type 
            });
            setNextSpawn();
        }

        for (let i = obstacles.length - 1; i >= 0; i--) {
            obstacles[i].x -= settings.speed;
            
            let isColliding = false;
            const o = obstacles[i];
            
            if (o.type === 'box') {
                isColliding = (player.x < o.x + o.w - 8 &&
                               player.x + player.w > o.x + 8 &&
                               player.y < o.y + o.h - 8 &&
                               player.y + player.h > o.y + 8);
            } else {
                // Spike collision
                isColliding = (player.x < o.x + o.w - 12 &&
                               player.x + player.w > o.x + 12 &&
                               player.y + player.h > o.y + 15);
            }

            if (isColliding) {
                gameState = 'GAMEOVER';
                document.getElementById('ui-gameover').classList.remove('hidden');
                document.getElementById('final-score').innerText = Math.floor(score/10);
                return;
            }

            if (o.x < -60) {
                obstacles.splice(i, 1);
                gems += (selectedMode === 'hardcore' ? 5 : (selectedMode === 'hard' ? 3 : 1));
                document.getElementById('gem-val').innerText = gems;
                localStorage.setItem('blox_gems', gems);
            }
        }
    }

    function draw() {
        // Clear background
        ctx.fillStyle = '#0f172a';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Ground
        ctx.fillStyle = '#1e293b';
        ctx.fillRect(0, canvas.height - 100, canvas.width, 100);
        ctx.strokeStyle = '#334155'; ctx.lineWidth = 4;
        ctx.strokeRect(0, canvas.height - 100, canvas.width, 4);

        if (gameState === 'PLAYING' || gameState === 'GAMEOVER') {
            // Player
            ctx.save();
            ctx.translate(player.x + player.w/2, player.y + player.h/2);
            ctx.rotate(player.rotation);
            ctx.fillStyle = skins[currentSkinIdx] ? skins[currentSkinIdx].color : '#10b981';
            ctx.fillRect(-player.w/2, -player.h/2, player.w, player.h);
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 3;
            ctx.strokeRect(-player.w/2, -player.h/2, player.w, player.h);
            ctx.restore();

            // Obstacles
            obstacles.forEach(o => {
                if (o.type === 'box') {
                    ctx.fillStyle = '#ef4444';
                    ctx.fillRect(o.x, o.y, o.w, o.h);
                    ctx.strokeStyle = '#fff'; ctx.lineWidth = 2;
                    ctx.strokeRect(o.x, o.y, o.w, o.h);
                } else {
                    ctx.fillStyle = '#f97316';
                    ctx.beginPath();
                    ctx.moveTo(o.x, o.y + o.h);
                    ctx.lineTo(o.x + o.w / 2, o.y);
                    ctx.lineTo(o.x + o.w, o.y + o.h);
                    ctx.closePath();
                    ctx.fill();
                    ctx.strokeStyle = '#fff'; ctx.lineWidth = 2;
                    ctx.stroke();
                }
            });
        }

        requestAnimationFrame(() => { update(); draw(); });
    }

    async function submitScore() {
        const nameInput = document.getElementById('player-name');
        const name = nameInput.value.trim() || "Anoniem";
        const finalScore = Math.floor(score/10);
        const btn = document.getElementById('submit-btn');

        if (!user) return;
        btn.disabled = true;
        btn.innerText = "VERZENDEN...";

        try {
            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('leaderboard').add({
                name: name,
                score: finalScore,
                mode: selectedMode,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                uid: user.uid
            });
            btn.innerText = "SCORE OPGESLAGEN!";
            document.getElementById('save-score-zone').classList.add('hidden');
        } catch (e) {
            btn.innerText = "FOUT BIJ OPSLAAN";
            btn.disabled = false;
        }
    }

    async function showLeaderboard() {
        document.querySelectorAll('.ui-overlay').forEach(u => u.classList.add('hidden'));
        document.getElementById('ui-leaderboard').classList.remove('hidden');
        const content = document.getElementById('leaderboard-content');
        content.innerHTML = '<p class="text-slate-400">Scores ophalen...</p>';

        try {
            const snapshot = await db.collection('artifacts').doc(appId)
                .collection('public').doc('data').collection('leaderboard')
                .orderBy('score', 'desc')
                .limit(10)
                .get();

            let html = '';
            let rank = 1;
            snapshot.forEach(doc => {
                const data = doc.data();
                html += `
                    <div class="leaderboard-item ${rank <= 3 ? 'top-3' : ''}">
                        <div class="flex items-center">
                            <span class="mr-3 text-slate-500">#${rank}</span>
                            <span>${data.name}</span>
                            <span class="mode-tag">${data.mode || 'easy'}</span>
                        </div>
                        <span class="text-yellow-400 font-black text-xl">${data.score}</span>
                    </div>
                `;
                rank++;
            });

            content.innerHTML = html || '<p>Nog geen scores...</p>';
        } catch (e) {
            content.innerHTML = '<p class="text-red-400">Leaderboard niet beschikbaar.</p>';
        }
    }

    function toggleShop() {
        const shop = document.getElementById('ui-shop');
        const menu = document.getElementById('ui-menu');
        if (shop.classList.contains('hidden')) {
            shop.classList.remove('hidden'); 
            menu.classList.add('hidden');
            renderShop();
        } else {
            shop.classList.add('hidden'); 
            menu.classList.remove('hidden');
        }
    }

    function renderShop() {
        const list = document.getElementById('skin-list');
        list.innerHTML = skins.map((s, i) => `
            <div onclick="selectSkin(${i})" class="p-4 border-2 ${currentSkinIdx === i ? 'border-yellow-400' : 'border-slate-700'} rounded-xl bg-slate-800 cursor-pointer hover:bg-slate-700 transition-colors">
                <div style="background: ${s.color}" class="w-12 h-12 mx-auto mb-2 rounded shadow-lg border border-white/20"></div>
                <div class="text-sm font-bold text-center">${s.name}</div>
            </div>
        `).join('');
    }

    function selectSkin(i) {
        currentSkinIdx = i;
        localStorage.setItem('blox_skin', i);
        renderShop();
    }

    window.onload = () => {
        resize();
        window.addEventListener('resize', resize);
        window.addEventListener('keydown', e => { 
            if(e.code === 'Space' || e.code === 'ArrowUp') {
                e.preventDefault();
                jump(); 
            }
        });
        window.addEventListener('touchstart', (e) => {
            if (gameState === 'PLAYING') {
                e.preventDefault();
                jump();
            }
        }, { passive: false });
        
        document.getElementById('gem-val').innerText = gems;
        draw();
    };
</script>
</body>
</html>